!function($){"use strict";var body=$(document.body),index=0;function getExt(e){return e.split(".").pop().toLowerCase()}function getFilename(e){var t=e.lastIndexOf(".");return e.substr(0,t)}var AjaxUpload=function(e,t){this.button=$(e),this.settings=$.extend({},AjaxUpload.default,t||{}),this.filename="",this.init()};AjaxUpload.default={name:"file",multiple:!1,action:"upload.php",accept:"image/*",fileType:["jpg","gif","png"],complete:$.noop,showMessage:function(e){"function"==typeof window.showMessage?showMessage(e,"error"):alert(e)}},AjaxUpload.prototype={init:function(){this.id=(new Date).getTime()+"_"+index++;var t=this,a=this.button,s=$('<input type="file" id="ajaxUploadInput_'+this.id+'">');this.settings.multiple?(s.attr("name",this.settings.name+"[]"),s.prop("multiple",!0)):s.attr("name",this.settings.name),this.settings.accept&&s.attr("accept",this.settings.accept);var e=$('<label class="ajax-upload" for="ajaxUploadInput_'+this.id+'">'+a.text()+"</label>"),i=$('<form class="ajax-upload" method="post" enctype="multipart/form-data"></form>');i.append(s).append(e),body.append(i),i.on("mouseleave",function(){this.style.display="none"}),a.on("mouseenter",function(){if(!a.hasClass("progress")){var e=a.offset();i.css({width:a.outerWidth(),height:a.outerHeight(),top:e.top,left:e.left,display:"block"})}}),s.on("change",function(){var e=$.trim(this.value);-1!==$.inArray(getExt(e),t.settings.fileType)?(a.addClass("progress"),window.FormData?(t.filename=getFilename(this.files[0].name),t.requestUpload(s,i)):t.emulateUpload(s,i)):t.settings.showMessage("文件格式错误,允许上传的文件格式为"+t.settings.fileType.join(","))})},requestUpload:function(e,t){var a=this;$.ajax(this.settings.action,{type:"POST",data:new FormData(t[0]),cache:!1,dataType:"json",contentType:!1,processData:!1}).always(function(){e.val(""),a.button.removeClass("progress")}).done(function(e){a.settings.complete.call(a,e)}).fail(function(){a.settings.showMessage("请求异常")})},emulateUpload:function(input,form){var self=this,iframeId="ajaxUploadIframe_"+this.id;form.attr({action:this.settings.action,target:iframeId});var iframe=$('<iframe id="'+iframeId+'" class="ajax-upload" src="javascript:false;" name="'+iframeId+'"></iframe>');iframe.on("load",function(){var response=$(this).contents().text();if(response)try{response=eval("("+response+")"),self.settings.complete.call(self,response)}catch(e){self.settings.showMessage("上传异常")}else self.settings.showMessage("请求异常");self.button.removeClass("progress"),iframe.remove(),self.init()}),body.append(iframe),form.trigger("submit")}},window.AjaxUpload=AjaxUpload}(jQuery);